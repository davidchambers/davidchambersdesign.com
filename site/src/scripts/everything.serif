(let [

fs              (require "node:fs")
path            (require "node:path")

base-template   (require "../base-template")
e               (require "../elements")
generate-css    (require "../generate-css")
masthead        (require "../masthead")
related-posts   (require "../related-posts")
render-archives (require "../render-archives")
render-page     (require "../render-page")
render-post     (require "../render-post")
render-tags     (require "../render-tags")
s               (require "../sanctuary")
icon:about      (require "../icons/about")
icon:archives   (require "../icons/archives")
icon:bitbucket  (require "../icons/bitbucket")
icon:contact    (require "../icons/contact")
icon:flushcache (require "../icons/flushcache")
icon:tags       (require "../icons/tags")
icon:twitter    (require "../icons/twitter")
dates           (require "../icons/dates")
pages           [(require "../pages/about")
                 (require "../pages/elam")]
posts           [(require "../posts/beautiful-painted-alphabet")
                 (require "../posts/show-full-directory-path-in-finder-window-title-bar")
                 (require "../posts/rounded-rectangles-in-adobe-illustrator-cs3")
                 (require "../posts/intelligent-css-caching")
                 (require "../posts/escape-special-characters-for-sql-regexp")
                 (require "../posts/david-carsons-2003-ted-lecture")
                 (require "../posts/wordpress-login-redirect")
                 (require "../posts/valid-xhtml-alternative-to-strike")
                 (require "../posts/changing-keyboard-shortcuts-in-mac-os-x")
                 (require "../posts/inserting-images-in-gmail-messages")
                 (require "../posts/django-syntax-highlighting-for-coda")
                 (require "../posts/looping-more-than-once-with-the-wordpress-loop")
                 (require "../posts/sms-event-reminders-from-google-calendar")
                 (require "../posts/tiny-calendar-icon-set")
                 (require "../posts/applescript-syntax-highlighting")
                 (require "../posts/php-brush-for-syntaxhighlighter")
                 (require "../posts/php-print_filesize-function")
                 (require "../posts/prototype-loader-for-syntaxhighlighter")
                 (require "../posts/associative-arrays-in-javascript")
                 (require "../posts/photoshop-save-for-web-javascript")
                 (require "../posts/incredible-performance-by-kseniya-simonova")
                 (require "../posts/coda-theme-for-syntaxhighlighter")
                 (require "../posts/tiny-calendar-icons-sprite")
                 (require "../posts/captions-over-images")
                 (require "../posts/embed-youtube-clips-using-valid-xhtml-markup")
                 (require "../posts/prototype-image-slider")
                 (require "../posts/sticky-footers")
                 (require "../posts/memorable-passwords-for-programmers")
                 (require "../posts/multisession-cd-burning-in-snow-leopard")
                 (require "../posts/css-fixed-position-headers")
                 (require "../posts/using-html5-time-element-in-wordpress-themes")
                 (require "../posts/prototype-and-scriptaculous-combined-and-compressed")
                 (require "../posts/autopopulating-input-fields-with-prototype")
                 (require "../posts/accessing-mysql-shell-via-terminal")
                 (require "../posts/duplicating-arrays-in-javascript")
                 (require "../posts/shockingly-simple-url-shortening")
                 (require "../posts/resize-browser-window-to-match-iphone-viewport-dimensions")
                 (require "../posts/get-attributes-of-django-model-or-instance")
                 (require "../posts/gorgeous-css3-buttons-inspired-by-aqua")
                 (require "../posts/cricket-field-diagrams")
                 (require "../posts/mootools-every-method")
                 (require "../posts/forcing-browsers-to-rerender-elements")
                 (require "../posts/css-image-switcher-done-the-right-way")
                 (require "../posts/fascinating-insight-into-the-mind-of-a-windows-user")
                 (require "../posts/using-google-for-site-search")
                 (require "../posts/extra-comma-considered-harmful")
                 (require "../posts/application-specific-volume-control-in-mac-os-x")
                 (require "../posts/linkify-tweets-with-regex")
                 (require "../posts/serializing-django-model-instances")
                 (require "../posts/freeing-myself-of-wordpress")
                 (require "../posts/optimization-via-stringification")
                 (require "../posts/autopopulating-input-fields-with-mootools")
                 (require "../posts/wmd-ftw")
                 (require "../posts/first-matching-item")
                 (require "../posts/settimeout-fix-for-webkit-transition")
                 (require "../posts/testing-django-apps-using-localhost-subdomains")
                 (require "../posts/empty-collections-are-valid-cache-data")
                 (require "../posts/-webkit-box-sizing")
                 (require "../posts/remove-textarea-scrollbars-in-internet-explorer")
                 (require "../posts/positioning-elements-using-mootools")
                 (require "../posts/javascript-everywhere")
                 (require "../posts/dieter-rams-video-interview")
                 (require "../posts/gmail-favicon-confusion")
                 (require "../posts/man-after-my-own-heart")
                 (require "../posts/digitalcolor-meter")
                 (require "../posts/python-loops-can-have-else-clause")
                 (require "../posts/self-caching-functions-in-javascript-and-python")
                 (require "../posts/efficient-rounding-in-javascript")
                 (require "../posts/filtering-lists-in-python-ruby-and-javascript")
                 (require "../posts/converting-integers-to-ordinals")
                 (require "../posts/bike-shelf")
                 (require "../posts/customizing-file-and-folder-icons-in-mac-os-x")
                 (require "../posts/ridding-markup-of-textual-decoration")
                 (require "../posts/javascript-date-and-time-localization")
                 (require "../posts/bitwise-not-operator-proves-useful-in-javascript")
                 (require "../posts/composing-mercurial-commit-messages-in-textmate")
                 (require "../posts/safari-keyboard-shortcut-to-open-current-page-in-google-chrome")
                 (require "../posts/simulating-nonlocal-in-python-2.x")
                 (require "../posts/faster-terminal-navigation-via-aliases")
                 (require "../posts/customizing-your-bash-prompt-for-pleasure-and-profit")
                 (require "../posts/mapping-file-extensions-to-emacs-syntax-modes")
                 (require "../posts/repeating-strings-in-javascript")
                 (require "../posts/changing-the-colour-of-list-bullets-using-css")
                 (require "../posts/solarized")
                 (require "../posts/hashify-editor")
                 (require "../posts/end-of-string-anchor-in-javascript-regular-expressions")
                 (require "../posts/getting-truth-out-of-the-dom")
                 (require "../posts/escaping-html-in-javascript")
                 (require "../posts/decorators-in-javascript")
                 (require "../posts/getting-started-with-socket.io")
                 (require "../posts/higher-level-style-sheets")
                 (require "../posts/helveticards")
                 (require "../posts/itunes-is-surprisingly-useful-when-learning-a-foreign-language")
                 (require "../posts/the-perils-of-using-javascript-objects-as-sets")
                 (require "../posts/give-and-take-of-continuation-passing-style")]

public (s/compose (.apply null _ path.join)
                  (s/concat [__dirname ".." ".." "public"]))

write-file (filename text -> (.apply null [filename text] fs.writeFileSync))

_ (write-file (public ["css" "screen.css"])
              generate-css)

render-svg
  (attrs ->
     (s/pipe [(e/svg (.apply null [{:xmlns "http://www.w3.org/2000/svg" :version "1.1"} attrs] Object.assign))
              (s/of Array)
              (s/fold-map String (:render _ "  " 0 false))
              (s/concat "<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n")
              (s/concat "<?xml version=\"1.0\" standalone=\"no\"?>\n")]))

_ (write-file (public ["svg" "masthead.svg"])
              (render-svg {} (:fill masthead)))

_ (write-file (public ["svg" "masthead-mask.svg"])
              (render-svg {} (:mask masthead)))

_ (write-file (public ["svg" "about.svg"])
              (render-svg {:width 16 :height 16} icon:about))

_ (write-file (public ["svg" "archives.svg"])
              (render-svg {:width 16 :height 16} icon:archives))

_ (write-file (public ["svg" "bitbucket.svg"])
              (render-svg {:width 16 :height 16} icon:bitbucket))

_ (write-file (public ["svg" "dates-0.svg"])
              (render-svg {} (0 dates)))

_ (write-file (public ["svg" "dates-1.svg"])
              (render-svg {} (1 dates)))

_ (write-file (public ["svg" "dates-2.svg"])
              (render-svg {} (2 dates)))

_ (write-file (public ["svg" "dates-3.svg"])
              (render-svg {} (3 dates)))

_ (write-file (public ["svg" "dates-4.svg"])
              (render-svg {} (4 dates)))

_ (write-file (public ["svg" "dates-5.svg"])
              (render-svg {} (5 dates)))

_ (write-file (public ["svg" "dates-6.svg"])
              (render-svg {} (6 dates)))

_ (write-file (public ["svg" "dates-7.svg"])
              (render-svg {} (7 dates)))

_ (write-file (public ["svg" "dates-8.svg"])
              (render-svg {} (8 dates)))

_ (write-file (public ["svg" "dates-9.svg"])
              (render-svg {} (9 dates)))

_ (write-file (public ["svg" "contact.svg"])
              (render-svg {:width 16 :height 16} icon:contact))

_ (write-file (public ["svg" "flushcache.svg"])
              (render-svg {:width 16 :height 16} icon:flushcache))

_ (write-file (public ["svg" "tags.svg"])
              (render-svg {:width 16 :height 16} icon:tags))

_ (write-file (public ["svg" "twitter.svg"])
              (render-svg {:width 16 :height 16} icon:twitter))

render-document (s/pipe [(s/of Array)
                         (s/fold-map String (:render _ "  " 0 false))
                         (s/concat "<!DOCTYPE html>\n")])

_ (write-file (public ["archives.html"])
              (render-document (base-template "Archives"
                                              (render-archives posts))))

_ (write-file (public ["tags.html"])
              (render-document (base-template "Tags"
                                              (render-tags posts))))

_ (s/map (page ->
            (write-file (public [(s/concat (:slug page) ".html")])
                        (render-document (base-template (:title page)
                                                        (render-page page)))))
         pages)

_ (s/map (post ->
            (write-file (public [(s/concat (:slug post) ".html")])
                        (render-document (base-template (:title post)
                                                        (render-post post
                                                                     (related-posts posts post))))))
         posts)

] 0)
