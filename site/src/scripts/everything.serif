import fs from "node:fs";
import path from "node:path";
import url from "node:url";

import S from "sanctuary";

import {svg} from "../elements.serif";
import base-template from "../base-template.serif";
import generate-css from "../generate-css.serif";
import masthead from "../masthead.serif";
import related-posts from "../related-posts.serif";
import render-archives from "../render-archives.serif";
import render-page from "../render-page.serif";
import render-post from "../render-post.serif";
import render-tags from "../render-tags.serif";
import icon/about from "../icons/about.serif";
import icon/archives from "../icons/archives.serif";
import icon/bitbucket from "../icons/bitbucket.serif";
import icon/contact from "../icons/contact.serif";
import icon/flushcache from "../icons/flushcache.serif";
import icon/tags from "../icons/tags.serif";
import icon/twitter from "../icons/twitter.serif";
import dates from "../icons/dates.serif";
import page/about from "../pages/about.serif";
import page/elam from "../pages/elam.serif";
import post/beautiful-painted-alphabet from "../posts/beautiful-painted-alphabet.serif";
import post/show-full-directory-path-in-finder-window-title-bar from "../posts/show-full-directory-path-in-finder-window-title-bar.serif";
import post/rounded-rectangles-in-adobe-illustrator-cs3 from "../posts/rounded-rectangles-in-adobe-illustrator-cs3.serif";
import post/intelligent-css-caching from "../posts/intelligent-css-caching.serif";
import post/escape-special-characters-for-sql-regexp from "../posts/escape-special-characters-for-sql-regexp.serif";
import post/david-carsons-2003-ted-lecture from "../posts/david-carsons-2003-ted-lecture.serif";
import post/wordpress-login-redirect from "../posts/wordpress-login-redirect.serif";
import post/valid-xhtml-alternative-to-strike from "../posts/valid-xhtml-alternative-to-strike.serif";
import post/changing-keyboard-shortcuts-in-mac-os-x from "../posts/changing-keyboard-shortcuts-in-mac-os-x.serif";
import post/inserting-images-in-gmail-messages from "../posts/inserting-images-in-gmail-messages.serif";
import post/django-syntax-highlighting-for-coda from "../posts/django-syntax-highlighting-for-coda.serif";
import post/looping-more-than-once-with-the-wordpress-loop from "../posts/looping-more-than-once-with-the-wordpress-loop.serif";
import post/sms-event-reminders-from-google-calendar from "../posts/sms-event-reminders-from-google-calendar.serif";
import post/tiny-calendar-icon-set from "../posts/tiny-calendar-icon-set.serif";
import post/applescript-syntax-highlighting from "../posts/applescript-syntax-highlighting.serif";
import post/php-brush-for-syntaxhighlighter from "../posts/php-brush-for-syntaxhighlighter.serif";
import post/php-print-filesize-function from "../posts/php-print_filesize-function.serif";
import post/prototype-loader-for-syntaxhighlighter from "../posts/prototype-loader-for-syntaxhighlighter.serif";
import post/associative-arrays-in-javascript from "../posts/associative-arrays-in-javascript.serif";
import post/photoshop-save-for-web-javascript from "../posts/photoshop-save-for-web-javascript.serif";
import post/incredible-performance-by-kseniya-simonova from "../posts/incredible-performance-by-kseniya-simonova.serif";
import post/coda-theme-for-syntaxhighlighter from "../posts/coda-theme-for-syntaxhighlighter.serif";
import post/tiny-calendar-icons-sprite from "../posts/tiny-calendar-icons-sprite.serif";
import post/captions-over-images from "../posts/captions-over-images.serif";
import post/embed-youtube-clips-using-valid-xhtml-markup from "../posts/embed-youtube-clips-using-valid-xhtml-markup.serif";
import post/prototype-image-slider from "../posts/prototype-image-slider.serif";
import post/sticky-footers from "../posts/sticky-footers.serif";
import post/memorable-passwords-for-programmers from "../posts/memorable-passwords-for-programmers.serif";
import post/multisession-cd-burning-in-snow-leopard from "../posts/multisession-cd-burning-in-snow-leopard.serif";
import post/css-fixed-position-headers from "../posts/css-fixed-position-headers.serif";
import post/using-html5-time-element-in-wordpress-themes from "../posts/using-html5-time-element-in-wordpress-themes.serif";
import post/prototype-and-scriptaculous-combined-and-compressed from "../posts/prototype-and-scriptaculous-combined-and-compressed.serif";
import post/autopopulating-input-fields-with-prototype from "../posts/autopopulating-input-fields-with-prototype.serif";
import post/accessing-mysql-shell-via-terminal from "../posts/accessing-mysql-shell-via-terminal.serif";
import post/duplicating-arrays-in-javascript from "../posts/duplicating-arrays-in-javascript.serif";
import post/shockingly-simple-url-shortening from "../posts/shockingly-simple-url-shortening.serif";
import post/resize-browser-window-to-match-iphone-viewport-dimensions from "../posts/resize-browser-window-to-match-iphone-viewport-dimensions.serif";
import post/get-attributes-of-django-model-or-instance from "../posts/get-attributes-of-django-model-or-instance.serif";
import post/gorgeous-css3-buttons-inspired-by-aqua from "../posts/gorgeous-css3-buttons-inspired-by-aqua.serif";
import post/cricket-field-diagrams from "../posts/cricket-field-diagrams.serif";
import post/mootools-every-method from "../posts/mootools-every-method.serif";
import post/forcing-browsers-to-rerender-elements from "../posts/forcing-browsers-to-rerender-elements.serif";
import post/css-image-switcher-done-the-right-way from "../posts/css-image-switcher-done-the-right-way.serif";
import post/fascinating-insight-into-the-mind-of-a-windows-user from "../posts/fascinating-insight-into-the-mind-of-a-windows-user.serif";
import post/using-google-for-site-search from "../posts/using-google-for-site-search.serif";
import post/extra-comma-considered-harmful from "../posts/extra-comma-considered-harmful.serif";
import post/application-specific-volume-control-in-mac-os-x from "../posts/application-specific-volume-control-in-mac-os-x.serif";
import post/linkify-tweets-with-regex from "../posts/linkify-tweets-with-regex.serif";
import post/serializing-django-model-instances from "../posts/serializing-django-model-instances.serif";
import post/freeing-myself-of-wordpress from "../posts/freeing-myself-of-wordpress.serif";
import post/optimization-via-stringification from "../posts/optimization-via-stringification.serif";
import post/autopopulating-input-fields-with-mootools from "../posts/autopopulating-input-fields-with-mootools.serif";
import post/wmd-ftw from "../posts/wmd-ftw.serif";
import post/first-matching-item from "../posts/first-matching-item.serif";
import post/settimeout-fix-for-webkit-transition from "../posts/settimeout-fix-for-webkit-transition.serif";
import post/testing-django-apps-using-localhost-subdomains from "../posts/testing-django-apps-using-localhost-subdomains.serif";
import post/empty-collections-are-valid-cache-data from "../posts/empty-collections-are-valid-cache-data.serif";
import post/-webkit-box-sizing from "../posts/-webkit-box-sizing.serif";
import post/remove-textarea-scrollbars-in-internet-explorer from "../posts/remove-textarea-scrollbars-in-internet-explorer.serif";
import post/positioning-elements-using-mootools from "../posts/positioning-elements-using-mootools.serif";
import post/javascript-everywhere from "../posts/javascript-everywhere.serif";
import post/dieter-rams-video-interview from "../posts/dieter-rams-video-interview.serif";
import post/gmail-favicon-confusion from "../posts/gmail-favicon-confusion.serif";
import post/man-after-my-own-heart from "../posts/man-after-my-own-heart.serif";
import post/digitalcolor-meter from "../posts/digitalcolor-meter.serif";
import post/python-loops-can-have-else-clause from "../posts/python-loops-can-have-else-clause.serif";
import post/self-caching-functions-in-javascript-and-python from "../posts/self-caching-functions-in-javascript-and-python.serif";
import post/efficient-rounding-in-javascript from "../posts/efficient-rounding-in-javascript.serif";
import post/filtering-lists-in-python-ruby-and-javascript from "../posts/filtering-lists-in-python-ruby-and-javascript.serif";
import post/converting-integers-to-ordinals from "../posts/converting-integers-to-ordinals.serif";
import post/bike-shelf from "../posts/bike-shelf.serif";
import post/customizing-file-and-folder-icons-in-mac-os-x from "../posts/customizing-file-and-folder-icons-in-mac-os-x.serif";
import post/ridding-markup-of-textual-decoration from "../posts/ridding-markup-of-textual-decoration.serif";
import post/javascript-date-and-time-localization from "../posts/javascript-date-and-time-localization.serif";
import post/bitwise-not-operator-proves-useful-in-javascript from "../posts/bitwise-not-operator-proves-useful-in-javascript.serif";
import post/composing-mercurial-commit-messages-in-textmate from "../posts/composing-mercurial-commit-messages-in-textmate.serif";
import post/safari-keyboard-shortcut-to-open-current-page-in-google-chrome from "../posts/safari-keyboard-shortcut-to-open-current-page-in-google-chrome.serif";
import post/simulating-nonlocal-in-python-2-x from "../posts/simulating-nonlocal-in-python-2.x.serif";
import post/faster-terminal-navigation-via-aliases from "../posts/faster-terminal-navigation-via-aliases.serif";
import post/customizing-your-bash-prompt-for-pleasure-and-profit from "../posts/customizing-your-bash-prompt-for-pleasure-and-profit.serif";
import post/mapping-file-extensions-to-emacs-syntax-modes from "../posts/mapping-file-extensions-to-emacs-syntax-modes.serif";
import post/repeating-strings-in-javascript from "../posts/repeating-strings-in-javascript.serif";
import post/changing-the-colour-of-list-bullets-using-css from "../posts/changing-the-colour-of-list-bullets-using-css.serif";
import post/solarized from "../posts/solarized.serif";
import post/hashify-editor from "../posts/hashify-editor.serif";
import post/end-of-string-anchor-in-javascript-regular-expressions from "../posts/end-of-string-anchor-in-javascript-regular-expressions.serif";
import post/getting-truth-out-of-the-dom from "../posts/getting-truth-out-of-the-dom.serif";
import post/escaping-html-in-javascript from "../posts/escaping-html-in-javascript.serif";
import post/decorators-in-javascript from "../posts/decorators-in-javascript.serif";
import post/getting-started-with-socket-io from "../posts/getting-started-with-socket.io.serif";
import post/higher-level-style-sheets from "../posts/higher-level-style-sheets.serif";
import post/helveticards from "../posts/helveticards.serif";
import post/itunes-is-surprisingly-useful-when-learning-a-foreign-language from "../posts/itunes-is-surprisingly-useful-when-learning-a-foreign-language.serif";
import post/the-perils-of-using-javascript-objects-as-sets from "../posts/the-perils-of-using-javascript-objects-as-sets.serif";
import post/give-and-take-of-continuation-passing-style from "../posts/give-and-take-of-continuation-passing-style.serif";

dirname = (path.dirname (url.fileURLToPath import.meta.url))

pages = #[
  page/about
  page/elam
]

posts = #[
  post/beautiful-painted-alphabet
  post/show-full-directory-path-in-finder-window-title-bar
  post/rounded-rectangles-in-adobe-illustrator-cs3
  post/intelligent-css-caching
  post/escape-special-characters-for-sql-regexp
  post/david-carsons-2003-ted-lecture
  post/wordpress-login-redirect
  post/valid-xhtml-alternative-to-strike
  post/changing-keyboard-shortcuts-in-mac-os-x
  post/inserting-images-in-gmail-messages
  post/django-syntax-highlighting-for-coda
  post/looping-more-than-once-with-the-wordpress-loop
  post/sms-event-reminders-from-google-calendar
  post/tiny-calendar-icon-set
  post/applescript-syntax-highlighting
  post/php-brush-for-syntaxhighlighter
  post/php-print-filesize-function
  post/prototype-loader-for-syntaxhighlighter
  post/associative-arrays-in-javascript
  post/photoshop-save-for-web-javascript
  post/incredible-performance-by-kseniya-simonova
  post/coda-theme-for-syntaxhighlighter
  post/tiny-calendar-icons-sprite
  post/captions-over-images
  post/embed-youtube-clips-using-valid-xhtml-markup
  post/prototype-image-slider
  post/sticky-footers
  post/memorable-passwords-for-programmers
  post/multisession-cd-burning-in-snow-leopard
  post/css-fixed-position-headers
  post/using-html5-time-element-in-wordpress-themes
  post/prototype-and-scriptaculous-combined-and-compressed
  post/autopopulating-input-fields-with-prototype
  post/accessing-mysql-shell-via-terminal
  post/duplicating-arrays-in-javascript
  post/shockingly-simple-url-shortening
  post/resize-browser-window-to-match-iphone-viewport-dimensions
  post/get-attributes-of-django-model-or-instance
  post/gorgeous-css3-buttons-inspired-by-aqua
  post/cricket-field-diagrams
  post/mootools-every-method
  post/forcing-browsers-to-rerender-elements
  post/css-image-switcher-done-the-right-way
  post/fascinating-insight-into-the-mind-of-a-windows-user
  post/using-google-for-site-search
  post/extra-comma-considered-harmful
  post/application-specific-volume-control-in-mac-os-x
  post/linkify-tweets-with-regex
  post/serializing-django-model-instances
  post/freeing-myself-of-wordpress
  post/optimization-via-stringification
  post/autopopulating-input-fields-with-mootools
  post/wmd-ftw
  post/first-matching-item
  post/settimeout-fix-for-webkit-transition
  post/testing-django-apps-using-localhost-subdomains
  post/empty-collections-are-valid-cache-data
  post/-webkit-box-sizing
  post/remove-textarea-scrollbars-in-internet-explorer
  post/positioning-elements-using-mootools
  post/javascript-everywhere
  post/dieter-rams-video-interview
  post/gmail-favicon-confusion
  post/man-after-my-own-heart
  post/digitalcolor-meter
  post/python-loops-can-have-else-clause
  post/self-caching-functions-in-javascript-and-python
  post/efficient-rounding-in-javascript
  post/filtering-lists-in-python-ruby-and-javascript
  post/converting-integers-to-ordinals
  post/bike-shelf
  post/customizing-file-and-folder-icons-in-mac-os-x
  post/ridding-markup-of-textual-decoration
  post/javascript-date-and-time-localization
  post/bitwise-not-operator-proves-useful-in-javascript
  post/composing-mercurial-commit-messages-in-textmate
  post/safari-keyboard-shortcut-to-open-current-page-in-google-chrome
  post/simulating-nonlocal-in-python-2-x
  post/faster-terminal-navigation-via-aliases
  post/customizing-your-bash-prompt-for-pleasure-and-profit
  post/mapping-file-extensions-to-emacs-syntax-modes
  post/repeating-strings-in-javascript
  post/changing-the-colour-of-list-bullets-using-css
  post/solarized
  post/hashify-editor
  post/end-of-string-anchor-in-javascript-regular-expressions
  post/getting-truth-out-of-the-dom
  post/escaping-html-in-javascript
  post/decorators-in-javascript
  post/getting-started-with-socket-io
  post/higher-level-style-sheets
  post/helveticards
  post/itunes-is-surprisingly-useful-when-learning-a-foreign-language
  post/the-perils-of-using-javascript-objects-as-sets
  post/give-and-take-of-continuation-passing-style
]

public components =
  (path.join ...#[dirname ".." ".." "public" ...components])

write-file filename data =
  (fs.writeFileSync ...#[filename data])

(write-file (public #["css" "screen.css"])
            generate-css)

render-svg attrs paths = {
  attrs' = #{:xmlns "http://www.w3.org/2000/svg" :version "1.1" ...attrs};
  "<?xml version=\"1.0\" standalone=\"no\"?>\n"
  + ((svg attrs' paths):render "  " 0 false)
}

(write-file (public #["svg" "masthead.svg"])
            (render-svg #{} masthead:fill))

(write-file (public #["svg" "masthead-mask.svg"])
            (render-svg #{} masthead:mask))

(write-file (public #["svg" "about.svg"])
            (render-svg #{:width 16 :height 16} icon/about))

(write-file (public #["svg" "archives.svg"])
            (render-svg #{:width 16 :height 16} icon/archives))

(write-file (public #["svg" "bitbucket.svg"])
            (render-svg #{:width 16 :height 16} icon/bitbucket))

(write-file (public #["svg" "dates-0.svg"])
            (render-svg #{} dates[0]))

(write-file (public #["svg" "dates-1.svg"])
            (render-svg #{} dates[1]))

(write-file (public #["svg" "dates-2.svg"])
            (render-svg #{} dates[2]))

(write-file (public #["svg" "dates-3.svg"])
            (render-svg #{} dates[3]))

(write-file (public #["svg" "dates-4.svg"])
            (render-svg #{} dates[4]))

(write-file (public #["svg" "dates-5.svg"])
            (render-svg #{} dates[5]))

(write-file (public #["svg" "dates-6.svg"])
            (render-svg #{} dates[6]))

(write-file (public #["svg" "dates-7.svg"])
            (render-svg #{} dates[7]))

(write-file (public #["svg" "dates-8.svg"])
            (render-svg #{} dates[8]))

(write-file (public #["svg" "dates-9.svg"])
            (render-svg #{} dates[9]))

(write-file (public #["svg" "contact.svg"])
            (render-svg #{:width 16 :height 16} icon/contact))

(write-file (public #["svg" "flushcache.svg"])
            (render-svg #{:width 16 :height 16} icon/flushcache))

(write-file (public #["svg" "tags.svg"])
            (render-svg #{:width 16 :height 16} icon/tags))

(write-file (public #["svg" "twitter.svg"])
            (render-svg #{:width 16 :height 16} icon/twitter))

render-document element = {
  "<!DOCTYPE html>\n" + (element:render "  " 0 false)
}

(write-file (public #["archives.html"])
            (render-document (base-template "Archives"
                                          (render-archives posts))))

(write-file (public #["tags.html"])
            (render-document (base-template "Tags"
                                            (render-tags posts))))

(S.map page =>
         (write-file (public #[page:slug + ".html"])
                     (render-document (base-template page:title
                                                     (render-page page))))
       pages)

(S.map post =>
         (write-file (public #[post:slug + ".html"])
                     (render-document (base-template post:title
                                                     (render-post post
                                                                  (related-posts posts post)))))
       posts)
