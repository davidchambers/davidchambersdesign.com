<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Simulating nonlocal in Python 2.x</title>
    <link rel="alternate" type="application/atom+xml" href="/feed/" />
    <link rel="stylesheet" href="/css/reset.css" media="all" />
    <link rel="stylesheet" href="/css/print.css" media="print" />
    <link rel="stylesheet" href="/css/screen.css" media="screen" />
    <link rel="shortcut icon" type="image/x-icon" href="http://static.davidchambersdesign.com/favicon.ico" />
    <script src="http://use.typekit.com/jhk0ogh.js"></script>
    <script>try{Typekit.load();}catch(e){}</script>
  </head>
  <body>
    <div id="skip">
      <a href="#main">Skip to main content</a>
    </div>
    <div id="wrap">
      <div id="header">
        <header>
          <a id="title" href="/">David Chambers Design</a>
          <hr />
          <p>It's where I share interesting info with other web geeks</p>
          <nav id="nav">
            <ul>
              <li><a href="/about/"><span><strong>About.</strong> Who I am and what I do.</span></a></li>
              <li><a href="/contact/"><span><strong>Contact.</strong> Just in case you want to get in touch.</span></a></li>
              <li><a href="/archives/"><span><strong>Archives.</strong> Old posts, recent posts, they're all here.</span></a></li>
              <li><a href="/tags/"><span><strong>Tags.</strong> Helpful if you're after posts on a particular topic.</span></a></li>
              <li><a href="https://bitbucket.org/davidchambers"><span><strong>Bitbucket.</strong> Home to most of my open-source projects.</span></a></li>
              <li><a href="/twitter/"><span><strong>Twitter.</strong> It's where I chirrup… or chirp… or something.</span></a></li>
            </ul>
          </nav>
        </header>
      </div>
      <div id="main">
        <article>
          <header>
            <h1>Simulating <code>nonlocal</code> in Python 2.x</h1>
            <time datetime="2011-02-05T19:30:00-08:00" pubdate="pubdate">5 February 2011</time>
          </header>
          <p><a href="http://en.wikipedia.org/wiki/Closure_(computer_science)">Closure</a> is truly wonderful. JavaScript — despite its plethora of quirks — is now widely appreciated, thanks in large part to its lexical scoping. Python 3 is lexically-scoped, too, as the following code demonstrates.</p>
          <pre><code>def cache(saved=None):
    def _(thing=None):
        nonlocal saved
        if thing is not None:
            saved = thing
        return saved
    return _
cache = cache()
  </code></pre>
          <p>If (the rebound) <code>cache</code> is passed no arguments (or <code>None</code>), <code>saved</code> is returned. Otherwise, <code>thing</code> is assigned to <code>saved</code> and returned.</p>
          <pre><code>&gt;&gt;&gt; cache(2**3)
8
&gt;&gt;&gt; cache()
8
  </code></pre>
          <p>This works thanks to the <code>nonlocal</code> keyword introduced in Python 3, which enables variables in outer scopes to be rebound. So how would one achieve the same result in earlier versions of Python?</p>
          <h3>Bringing lexical scoping to Python 2.x</h3>
          <pre><code>def cache(saved=None):
    def _(thing=None):
        # nonlocal saved
        if thing is not None:
            saved = thing
        return saved
    return _
cache = cache()
  </code></pre>
          <p>The <code>nonlocal</code> line is commented out as it's a syntax error in Python 2.x.</p>
          <pre><code>&gt;&gt;&gt; cache(2**3)
8
&gt;&gt;&gt; cache()
...
UnboundLocalError: local variable 'saved' referenced before assignment
  </code></pre>
          <p>When <code>cache</code> is passed a (non-<code>None</code>) <code>thing</code>, a <em>new</em> <code>saved</code> is created within the local scope. When <code>cache</code> is passed no arguments (or <code>None</code>), execution skips to <code>return saved</code>. At this point, <code>saved</code> is expected to exist within the local scope – it does not, which explains the <code>UnboundLocalError</code>.</p>
          <p>It is possible to simulate lexical scoping in Python 2.x. The approaches I find most palatable utilize a dictionary or a function object as a namespace accessible to both the inner and outer functions.</p>
          <h4>Dictionary</h4>
          <pre><code>def cache():
    ns = {'saved': None}
    def _(thing=None):
        if thing is not None:
            ns['saved'] = thing
        return ns['saved']
    return _
cache = cache()
  </code></pre>
          <h4>Function object</h4>
          <pre><code>def cache():
    def ns(): pass
    ns.saved = None
    def _(thing=None):
        if thing is not None:
            ns.saved = thing
        return ns.saved
    return _
cache = cache()
  </code></pre>
          <p>The dictionary approach is arguably more correct, but subscript notation hurts my eyes so I prefer to stick things on a function object. It's useful that <code>def ns(): pass</code> looks odd, as it alerts the reader to the fact that something <em>is</em> odd.</p>
          <footer class="metadata">
            <ul>
              <li class="shorturl"><a href="http://dċd.ws/78/">Short URL</a></li>
            </ul>
            <h4>This post has the following tags:</h4>
            <ol>
              <li><a href="/tag/hacks/">hacks</a></li>
              <li><a href="/tag/programming/">programming</a></li>
              <li><a href="/tag/python/">Python</a></li>
            </ol>
          </footer>
          <h3 id="related">Possibly related posts</h3>
          <ul>
            <li><a href="/converting-integers-to-ordinals/">Converting integers to ordinals</a></li>
            <li><a href="/self-caching-functions-in-javascript-and-python/">Self-caching functions in JavaScript and Python</a></li>
            <li><a href="/filtering-lists-in-python-ruby-and-javascript/">Filtering lists in Python, Ruby, and JavaScript</a></li>
            <li><a href="/python-loops-can-have-else-clause/">Python loops can have else clause?!</a></li>
            <li><a href="/the-perils-of-using-javascript-objects-as-sets/">The perils of using JavaScript objects as sets</a></li>
          </ul>
        </article>
      </div>
    </div>
    <footer>
      <p>Powered by <a href="http://mango.io/wtf?" data-version="0.9dev">Mango</a>. Hosted on <a href="http://www.linode.com/?r=ce523c9eeda64e4bceaf7011dc9e8558b909711d">Linode</a>. Original content <a href="/copying/">WTFPL-licensed</a>.</p>
    </footer>
  </body>
</html>
